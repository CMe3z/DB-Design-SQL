/* **************************************
*                                       *
*  DBS201                               * 
*  Chad Medeiros                        *
*  Created on: Nov 15, 2014             *
*  Last Modified: July 9, 2014          *
*                                       *
*************************************** */
/*  Tasks to be accomplished:
    -	CREATE A COLLECTION
    -	USE BELOW DBDL TO CREATE ALL TABLES.
    -	ADD THE PRIMARY KEYS AND FOREIGN KEYS TO THEM
    -	INSERT, UPDATE, AND DELETE COUPLE OF RECORDS FROM EACH TABLE
    -	WRITE TWO SELECT STATEMENTS TO RETRIEVE DATA USING SINGLE TABLE AND MULTIPLE TABLES (JOIN)
    -	ALTER THE STRUCTURE OF TABLES (ADD AND MODIFY COLUMNS).
                                                                                                   */
CREATE DATABASE CMED85;

CREATE TABLE CMED85.AUTHOR (
	AUTH_ID		VARCHAR(10) CONSTRAINT CMED85.AUTHOR_PK PRIMARY KEY,
	AUTH_FNAME	VARCHAR(50),
	AUTH_LNAME	VARCHAR(50));
	
CREATE TABLE CMED85.PRODUCT (
	PROD_ID		VARCHAR(10),
	TITLE		VARCHAR(200),
	EDITION		VARCHAR(100),
	PURCH_COST	DECIMAL(5, 2),	
	RETAIL_PRC	DECIMAL(5, 2),
	 CONSTRAINT CMED85.PRODUCT_PK PRIMARY KEY(PROD_ID));

CREATE TABLE CMED85.POSITION (
	POSITION_ID	VARCHAR(10) CONSTRAINT CMED85.POSITION_PK PRIMARY KEY,
	POS_DESC	VARCHAR(100));
	
CREATE TABLE CMED85.EMPLOYEE (
	EMP_ID		VARCHAR(10),
	EMP_FNAME	VARCHAR(50),
	EMP_LNAME	VARCHAR(50),
	SOC_INS		CHAR(9),	
	POSITION_ID	VARCHAR(10),
	SUPERVIS_ID	VARCHAR(10) CONSTRAINT CMED85.EMPLOYEE_SUPR_FK
		REFERENCES CMED85.EMPLOYEE(EMP_ID),	
	HIREDATE	DATE,
	 CONSTRAINT CMED85.EMPLOYEE_PK PRIMARY KEY(EMP_ID),
	 CONSTRAINT CMED85.EMPLOYEE_POSN_FK FOREIGN KEY (POSITION_ID) 
		REFERENCES CMED85.POSITION(POSITION_ID));
	
CREATE TABLE CMED85.PROD_AUTHOR (
	PROD_ID		VARCHAR(10) CONSTRAINT CMED85.PRODAUTH_PROD_FK
		REFERENCES CMED85.PRODUCT(PROD_ID),
	AUTH_ID		VARCHAR(10) CONSTRAINT CMED85.PRODAUTH_AUTH_FK
		REFERENCES CMED85.AUTHOR(AUTH_ID),
	 CONSTRAINT CMED85.PRODAUTH_PK PRIMARY KEY(PROD_ID, AUTH_ID));
	 
CREATE TABLE CMED85.CUSTOMER (
	CUST_NO		INTEGER CONSTRAINT CMED85.CUSTOMER_PK PRIMARY KEY,
	CUST_NAME	VARCHAR(100) CONSTRAINT CMED85.CUST_NAME_UK UNIQUE,
	LOCATION	VARCHAR(100),	
	REP_ID		VARCHAR(10) CONSTRAINT CMED85.CUSTOMER_REP_FK
		REFERENCES CMED85.EMPLOYEE(EMP_ID));
		
CREATE TABLE CMED85.INVOICE (
	INVOICE_NO	INTEGER CONSTRAINT CMED85.INVOICE_PK PRIMARY KEY,
	INV_DATE	DATE,
	CUST_NO		INTEGER CONSTRAINT CMED85.INVOICE_CUST_FK
		REFERENCES CMED85.CUSTOMER(CUST_NO));
		
CREATE TABLE CMED85.INVOICE_DETAILS (
	INVOICE_NO	INTEGER CONSTRAINT CMED85.INVDET_INVOICE_FK
		REFERENCES CMED85.INVOICE(INVOICE_NO),
	PROD_ID		VARCHAR(10) CONSTRAINT CMED85.INVDET_PRODUCT_FK
		REFERENCES CMED85.PRODUCT(PROD_ID),
	QUANTITY	INTEGER,
	PRICE		DECIMAL (7, 2),
	 CONSTRAINT CMED85.INVDET_PK PRIMARY KEY(INVOICE_ID, PROD_ID));

-- Begin inserting values into tables: 
INSERT INTO CMED85.AUTHOR
	VALUES
	 ('DB1', 'Dan', 'Brown'),
	 ('AC1', 'Agatha', 'Christie'),
	 ('JA1', 'Jane', 'Austen'),
	 ('DB2', 'Dorothy', 'Boufant');
	
DELETE FROM CMED85.AUTHOR
	WHERE AUTH_ID ='DB2');
	
INSERT INTO CMED85.PRODUCT
	VALUES
	 ('AD1', 'Angels and Demons', '2007', '6.98', '10.85'),
	 ('MO1', 'Murder on the Orient Express', '2012', '7.66', '11.97'),
	 ('DON1', 'Death Nile', '2011', '7.78', '12.43');
	
UPDATE CMED85.PRODUCT
	SET TITLE = 'Death on the Nile' 
	WHERE PROD_ID = 'DON1';
	
INSERT INTO CMED85.POSITION
	VALUES
	 ('SR1', 'Sales Agent'),
	 ('SU1', 'Sales Supervisor');

INSERT INTO CMED85.EMPLOYEE
	VALUES
	 ('1', 'Gary', 'Springer', '854986145', 'SR1', '3', '31/10/2012'),
	 ('2', 'Sandra', 'Bullock', '125489658', 'SR1', '3', '31/10/2012'),
	 ('3', 'Hugo', 'Boss', '658457922', 'SU1', Null, '31/10/2011');

INSERT INTO CMED85.POSITION
	VALUES ('RM1', 'Regional Manager');

INSERT INTO CMED85.EMPLOYEE
	VALUES ('4', 'Prince', 'Charming', '999999999', 'RM1', Null, '31/2/2003');

UPDATE CMED85.EMPLOYEE
	SET SUPERVIS_ID = '4'
	WHERE EMP_ID = '3';

INSERT INTO CMED85.POSITION
	VALUES ('RM1', 'Regional Manager');

INSERT INTO CMED85.PROD_AUTHOR
	VALUES 
	 ('AD1', 'DB1'),
	 ('MO1', 'AC1'),
	 ('DON1', 'AC1');
	
INSERT INTO CMED85.CUSTOMER
	VALUES 
	 ('1', 'Seneca@York', 'Toronto', '1'),
	 ('2', 'Ryerson', 'Toronto', '2'),
 	 ('3', 'Seneca Newnham', 'Toronto', '1'),
 	 ('4', 'Queens', 'Quebec', '1');

INSERT INTO CMED85.INVOICE
	VALUES 
	 ('1', '31/10/2014', '1'),
	 ('2', '22/11/2014', '2');

INSERT INTO CMED85.INVOICE_DETAIL
	VALUES
	 ('1', 'AD1', '1', '10.85'),
	 ('1', 'MO1', '2', '23.94'),
	 ('2', 'DON1', '1', '12.43');

-- Alter structure of tables
-- Add Published Date to PRODUCT information:
ALTER TABLE CMED85.PRODUCT
	ADD COLUMN PUBLISHED DATE;
	
-- Add data for new column:
UPDATE CMED85.PRODUCT
	SET PUBLISHED = '2007-02-02' WHERE PROD_ID = 'AD1', 
	SET PUBLISHED = '2012-03-16' WHERE PROD_ID = 'MO1', 
	SET PUBLISHED = '2011-03-03' WHERE PROD_ID = 'DON1';
		
-- Change max value of Purchase cost and Retail price of items, so we can sell something for $10,000.00!:
ALTER TABLE CMED85.PRODUCT
	ALTER 
	 PURCH_COST SET DATA TYPE DECIMAL(7, 2),
	 RETAIL_PRC SET DATA TYPE DECIMAL(7, 2);
	
-- Remove UNIQUE flag on Customer Name:
ALTER TABLE CMED85.CUSTOMER
	DROP UNIQUE CMED85.CUST_NAME_UK;
	
-- Show products published after 2011:
SELECT PROD_ID, TITLE
	FROM CMED85.PRODUCT
	WHERE PUBLISHED >= '2011-01-01';

-- Show all Sales Agents and Supervisors first name, last name, and position title:
SELECT EMP_FNAME, EMP_LNAME, POS_DESC
	FROM CMED85.EMPLOYEE INNER JOIN CMED85.POSITION 
	ON (CMED85.POSITION.POSITION_ID = CMED85.EMPLOYEE.POSITION_ID)
	WHERE  POSITION_ID = 'SR1'
	OR POSITION_ID = 'SU1';
